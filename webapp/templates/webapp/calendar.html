{% extends 'webapp/base.html' %}

{% block title %}Randevu Takvimi - Damla Vize CRM{% endblock %}

{% block page_title %}Randevu Takvimi{% endblock %}

{% block content %}
<!-- Üst Bar -->
<div class="flex justify-between items-center mb-4">
    <a href="{% url 'webapp:dashboard' %}" class="flex items-center text-bordo hover:text-bordo-dark">
        <i class="fas fa-arrow-left mr-2"></i>
        <span>Geri Dön</span>
    </a>
</div>

<div class="bg-white rounded-xl shadow p-6">
    <!-- Takvim Container -->
    <div id="calendar"></div>
</div>

<!-- Randevu Ekleme Modal -->
<div id="appointmentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Yeni Randevu</h3>
            <form id="appointmentForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tarih</label>
                    <input type="date" id="appointmentDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-bordo focus:border-bordo" readonly>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Saat</label>
                    <input type="time" id="appointmentTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-bordo focus:border-bordo" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Müşteri Adı</label>
                    <input type="text" id="customerName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-bordo focus:border-bordo" placeholder="Müşteri adını girin" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
                    <input type="tel" id="customerPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-bordo focus:border-bordo" placeholder="+90 5XX XXX XX XX">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notlar</label>
                    <textarea id="appointmentNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-bordo focus:border-bordo" placeholder="Randevu notları..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAppointmentModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                        İptal
                    </button>
                    <button type="submit" class="px-4 py-2 bg-bordo text-white rounded-md hover:bg-bordo-dark">
                        Randevu Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Randevu Detay Modal -->
<div id="eventDetailModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Randevu Detayları</h3>
            <div id="eventDetails" class="space-y-3">
                <!-- Detaylar JavaScript ile doldurulacak -->
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="deleteEvent()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    Sil
                </button>
                <button onclick="closeEventDetailModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                    Kapat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar CSS ve JS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/tr.js'></script>

<style>
    #calendar {
        max-width: 100%;
        height: 600px;
    }
    
    .fc-event {
        cursor: pointer;
        border: none;
        padding: 2px 5px;
    }
    
    .fc-day:hover {
        background-color: #f3f4f6;
        cursor: pointer;
    }
    
    .fc-today {
        background-color: #fef2f2 !important;
    }
    
    /* Bordo tema için özelleştirmeler */
    .fc-button-primary {
        background-color: #A18E62 !important;
        border-color: #A18E62 !important;
    }
    
    .fc-button-primary:hover {
        background-color: #A18E62 !important;
        border-color: #A18E62 !important;
    }
    
    .fc-button-active {
        background-color: #A18E62 !important;
        border-color: #A18E62 !important;
    }
    
    .fc-col-header-cell {
        background-color: #f9fafb;
        font-weight: 600;
    }
</style>

<script>
    let calendar;
    let selectedEvent = null;
    
    // LocalStorage'dan randevuları al
    function getAppointments() {
        const appointments = localStorage.getItem('appointments');
        return appointments ? JSON.parse(appointments) : [];
    }
    
    // LocalStorage'a randevuları kaydet
    function saveAppointments(appointments) {
        localStorage.setItem('appointments', JSON.stringify(appointments));
    }
    
    // Randevu modalını aç
    function openAppointmentModal(date) {
        document.getElementById('appointmentDate').value = date;
        document.getElementById('appointmentModal').classList.remove('hidden');
    }
    
    // Randevu modalını kapat
    function closeAppointmentModal() {
        document.getElementById('appointmentModal').classList.add('hidden');
        document.getElementById('appointmentForm').reset();
    }
    
    // Event detay modalını aç
    function openEventDetailModal(event) {
        selectedEvent = event;
        const details = `
            <div class="border-b pb-2 mb-2">
                <span class="font-medium">Müşteri:</span> ${event.extendedProps.customerName}
            </div>
            ${event.extendedProps.customerPhone ? `
            <div class="border-b pb-2 mb-2">
                <span class="font-medium">Telefon:</span> ${event.extendedProps.customerPhone}
            </div>
            ` : ''}
            <div class="border-b pb-2 mb-2">
                <span class="font-medium">Tarih:</span> ${new Date(event.start).toLocaleDateString('tr-TR')}
            </div>
            <div class="border-b pb-2 mb-2">
                <span class="font-medium">Saat:</span> ${new Date(event.start).toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})}
            </div>
            ${event.extendedProps.notes ? `
            <div class="border-b pb-2 mb-2">
                <span class="font-medium">Notlar:</span> ${event.extendedProps.notes}
            </div>
            ` : ''}
        `;
        document.getElementById('eventDetails').innerHTML = details;
        document.getElementById('eventDetailModal').classList.remove('hidden');
    }
    
    // Event detay modalını kapat
    function closeEventDetailModal() {
        document.getElementById('eventDetailModal').classList.add('hidden');
        selectedEvent = null;
    }
    
    // Event sil
    function deleteEvent() {
        if (selectedEvent && confirm('Bu randevuyu silmek istediğinizden emin misiniz?')) {
            selectedEvent.remove();
            
            // LocalStorage'dan sil
            let appointments = getAppointments();
            appointments = appointments.filter(a => a.id !== selectedEvent.id);
            saveAppointments(appointments);
            
            closeEventDetailModal();
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        
        // Kayıtlı randevuları yükle
        const savedAppointments = getAppointments();
        const events = savedAppointments.map(apt => ({
            id: apt.id,
            title: apt.customerName,
            start: apt.datetime,
            backgroundColor: '#A18E62', // GOLD renk
            borderColor: '#A18E62',
            extendedProps: {
                customerName: apt.customerName,
                customerPhone: apt.customerPhone,
                notes: apt.notes
            }
        }));
        
        // Randevu hatırlatma kontrolü
        checkAppointmentReminders();
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'tr',
            height: 600,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Bugün',
                month: 'Ay',
                week: 'Hafta',
                day: 'Gün'
            },
            events: events,
            editable: true,
            selectable: true,
            selectMirror: true,
            eventClick: function(info) {
                openEventDetailModal(info.event);
            },
            dateClick: function(info) {
                openAppointmentModal(info.dateStr);
            },
            eventDrop: function(info) {
                // Sürükle-bırak ile tarih değiştirme
                updateAppointmentInStorage(info.event);
            }
        });
        
        calendar.render();
    });
    
    // LocalStorage'da randevuyu güncelle
    function updateAppointmentInStorage(event) {
        let appointments = getAppointments();
        const index = appointments.findIndex(a => a.id === event.id);
        if (index !== -1) {
            appointments[index].datetime = event.start.toISOString();
            saveAppointments(appointments);
        }
    }
    
    // Form gönderimi
    document.getElementById('appointmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const date = document.getElementById('appointmentDate').value;
        const time = document.getElementById('appointmentTime').value;
        const customerName = document.getElementById('customerName').value;
        const customerPhone = document.getElementById('customerPhone').value;
        const notes = document.getElementById('appointmentNotes').value;
        
        // Tarih ve saati birleştir
        const datetime = new Date(date + 'T' + time);
        
        // Yeni randevu oluştur
        const newAppointment = {
            id: Date.now().toString(),
            customerName: customerName,
            customerPhone: customerPhone,
            datetime: datetime.toISOString(),
            notes: notes
        };
        
        // LocalStorage'a kaydet
        const appointments = getAppointments();
        appointments.push(newAppointment);
        saveAppointments(appointments);
        
        // Takvime ekle
        calendar.addEvent({
            id: newAppointment.id,
            title: customerName,
            start: datetime,
            backgroundColor: '#A18E62',
            borderColor: '#A18E62',
            extendedProps: {
                customerName: customerName,
                customerPhone: customerPhone,
                notes: notes
            }
        });
        
        // Modalı kapat
        closeAppointmentModal();
    });
    
    // Randevu hatırlatma fonksiyonu
    function checkAppointmentReminders() {
        const appointments = getAppointments();
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        appointments.forEach(appointment => {
            const appointmentDate = new Date(appointment.datetime);
            const appointmentDay = new Date(appointmentDate.getFullYear(), appointmentDate.getMonth(), appointmentDate.getDate());
            
            // Bugünkü randevular için hatırlatma
            if (appointmentDay.getTime() === today.getTime()) {
                const appointmentTime = appointmentDate.toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'});
                const message = `${appointment.customerName} ile ${appointmentTime} randevunuz var.`;
                
                // Bildirim daha önce gönderilmediyse ekle
                if (!isNotificationSent(appointment.id, 'today')) {
                    addNotification('Bugünkü Randevu', message, 'appointment');
                    markNotificationAsSent(appointment.id, 'today');
                }
            }
            
            // Yarınki randevular için hatırlatma
            if (appointmentDay.getTime() === tomorrow.getTime()) {
                const appointmentTime = appointmentDate.toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'});
                const message = `Yarın ${appointment.customerName} ile ${appointmentTime} randevunuz var.`;
                
                if (!isNotificationSent(appointment.id, 'tomorrow')) {
                    addNotification('Yarınki Randevu', message, 'appointment');
                    markNotificationAsSent(appointment.id, 'tomorrow');
                }
            }
        });
    }
    
    // Bildirim gönderildi mi kontrol et
    function isNotificationSent(appointmentId, type) {
        const key = `notification_${appointmentId}_${type}`;
        return localStorage.getItem(key) === 'sent';
    }
    
    // Bildirimi gönderildi olarak işaretle
    function markNotificationAsSent(appointmentId, type) {
        const key = `notification_${appointmentId}_${type}`;
        localStorage.setItem(key, 'sent');
    }
    
    // Her 5 dakikada bir hatırlatmaları kontrol et
    setInterval(checkAppointmentReminders, 5 * 60 * 1000);
    
    // Sayfa görünür olduğünde kontrol et
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            checkAppointmentReminders();
        }
    });
</script>
{% endblock %}
